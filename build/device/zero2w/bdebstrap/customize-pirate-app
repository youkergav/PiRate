#!/bin/sh
set -eu

# $1 is the rootfs mountpoint (chroot base)
ROOT="$1"

# Host repo root (where pyproject.toml and dist/ live)
SELF_DIR="$(cd "$(dirname "$0")" && pwd)"
REPO_ROOT="$(cd "$SELF_DIR/../../../../" && pwd)"
WHEEL_SRC="$(ls -t "$REPO_ROOT"/dist/pirate-*.whl 2>/dev/null | head -n1 || true)"

# Stage inside chroot and install
STAGE_DIR="/tmp/pirate"
mkdir -p "$ROOT$STAGE_DIR"
cp "$WHEEL_SRC" "$ROOT$STAGE_DIR/"

chroot "$ROOT" /usr/bin/env bash -eux <<'CHROOT'
set -eu
python3 -m pip install --no-cache-dir --break-system-packages /tmp/pirate/pirate-*.whl
rm -rf /tmp/pirate
CHROOT
