#!/bin/sh
set -eu

# $1 is the rootfs mountpoint (chroot base)
ROOT="$1"

# Define variables
SELF_DIR="$(cd "$(dirname "$0")" && pwd)"
REPO_ROOT="$(cd "$SELF_DIR/../../../../" && pwd)"
SRC_IN_CHROOT="/opt/pirate"

# Copy the source into the chroot so pip can install from it
mkdir -p "$ROOT$SRC_IN_CHROOT"
rsync -a --delete \
  --exclude='.git' \
  --exclude='__pycache__' \
  --exclude='*.pyc' \
  --exclude='*.egg-info' \
  "$REPO_ROOT/" "$ROOT$SRC_IN_CHROOT/"

# Install the app (reads pyproject.toml; installs deps)
chroot "$ROOT" /usr/bin/env bash -eux <<CHROOT
python3 -m pip install --no-cache-dir --break-system-packages "$SRC_IN_CHROOT"
CHROOT

# Cleanup source files
rm -rf "$ROOT$SRC_IN_CHROOT"
